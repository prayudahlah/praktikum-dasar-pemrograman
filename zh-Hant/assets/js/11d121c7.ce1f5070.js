"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["928"],{52302:function(e,n,t){t.r(n),t.d(n,{metadata:()=>o,contentTitle:()=>c,default:()=>u,assets:()=>a,toc:()=>d,frontMatter:()=>i});var o=JSON.parse('{"id":"external-stores/index","title":"\u72C0\u614B\u7BA1\u7406","description":"\u5982\u679C\u60A8\u5E0C\u671B\u5C07\u7DE8\u8F2F\u904E\u7684\u4EE3\u78BC\u584A\u5B58\u5132\u5230\u8CC7\u6599\u5EAB\u800C\u4E0D\u662F\u700F\u89BD\u5668\u7684\u672C\u5730\u5B58\u5132\u4E2D\uFF0C\u60A8\u53EF\u4EE5\u901A\u904E\u63D0\u4F9B\u81EA\u5DF1\u7684\u72C0\u614B\u7BA1\u7406\u4F86\u540C\u6B65\u5230 docusaurus-live-brython\u3002\u9019\u53EF\u4EE5\u901A\u904E\u4EA4\u63DB CodeEditor/hooks/useScript \u548C CodeEditor/WithScript/ScriptContext \u4F86\u5B8C\u6210\u3002\u8981\u5728 docusaurus-live-brython \u548C\u60A8\u7684\u72C0\u614B\u7BA1\u7406\u4E4B\u9593\u9032\u884C\u540C\u6B65\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528 React \u7684 useSyncExternalStore \u9264\u5B50\u3002","source":"@site/i18n/zh-Hant/docusaurus-plugin-content-docs/current/external-stores/index.md","sourceDirName":"external-stores","slug":"/external-stores/","permalink":"/praktikum-dasar-pemrograman/zh-Hant/docs/external-stores/","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10},"sidebar":"defaultSidebar","previous":{"title":"\u5143\u6CE8\u91CB","permalink":"/praktikum-dasar-pemrograman/zh-Hant/docs/meta-comments/"},"next":{"title":"intro","permalink":"/praktikum-dasar-pemrograman/zh-Hant/docs/materi/intro"}}'),r=t("85893"),s=t("50065");let i={sidebar_position:10},c="\u72C0\u614B\u7BA1\u7406",a={},d=[{value:"Mobx",id:"mobx",level:2}];function l(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,s.a)(),...e.components},{Details:t}=n;return!t&&function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u72C0\u614B\u7BA1\u7406",children:"\u72C0\u614B\u7BA1\u7406"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679C\u60A8\u5E0C\u671B\u5C07\u7DE8\u8F2F\u904E\u7684\u4EE3\u78BC\u584A\u5B58\u5132\u5230\u8CC7\u6599\u5EAB\u800C\u4E0D\u662F\u700F\u89BD\u5668\u7684\u672C\u5730\u5B58\u5132\u4E2D\uFF0C\u60A8\u53EF\u4EE5\u901A\u904E\u63D0\u4F9B\u81EA\u5DF1\u7684\u72C0\u614B\u7BA1\u7406\u4F86\u540C\u6B65\u5230 ",(0,r.jsx)(n.code,{children:"docusaurus-live-brython"}),"\u3002\u9019\u53EF\u4EE5\u901A\u904E\u4EA4\u63DB ",(0,r.jsx)(n.code,{children:"CodeEditor/hooks/useScript"})," \u548C ",(0,r.jsx)(n.code,{children:"CodeEditor/WithScript/ScriptContext"})," \u4F86\u5B8C\u6210\u3002\u8981\u5728 ",(0,r.jsx)(n.code,{children:"docusaurus-live-brython"})," \u548C\u60A8\u7684\u72C0\u614B\u7BA1\u7406\u4E4B\u9593\u9032\u884C\u540C\u6B65\uFF0C\u60A8\u53EF\u4EE5\u4F7F\u7528 React \u7684 ",(0,r.jsx)(n.code,{children:"useSyncExternalStore"})," \u9264\u5B50\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"mobx",children:"Mobx"}),"\n",(0,r.jsxs)(n.p,{children:["\uD83D\uDC49 \u6F14\u793A\u5009\u5EAB: ",(0,r.jsx)(n.a,{href:"https://github.com/lebalz/docusaurus-mobx-live-code",children:"lebalz/docusaurus-mobx-live-code"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u5047\u8A2D\u60A8\u6709\u4E00\u500B ",(0,r.jsx)(n.code,{children:"DocumentStore"})," \u4F86\u5B58\u5132 ",(0,r.jsx)(n.code,{children:"Document"}),"\uFF08\u5176\u4E2D\u5305\u542B\u4EE3\u78BC\u584A\uFF09\uFF0C\u4E26\u4E14\u60A8\u5E0C\u671B\u5C07 ",(0,r.jsx)(n.code,{children:"DocumentStore"})," \u7684\u66F4\u6539\u540C\u6B65\u5230 ",(0,r.jsx)(n.code,{children:"docusaurus-live-brython"}),"\u3002\u9019\u4F7F\u60A8\u53EF\u4EE5\u5C07\u4EE3\u78BC\u584A\u5B58\u5132\u5728\u8CC7\u6599\u5EAB\u4E2D\u3002"]}),"\n",(0,r.jsxs)(t,{children:[(0,r.jsx)("summary",{children:(0,r.jsx)(n.code,{children:"src/stores/DocumentStore"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="src/stores/documentStore.ts"',children:"import { action, computed, makeObservable, observable, override } from 'mobx';\nimport { RootStore } from './rootStore';\nimport { computedFn } from 'mobx-utils';\nimport Document from '../models/Document';\nimport { type RouterType } from '@docusaurus/types';\n\nexport class DocumentStore {\n    readonly root: RootStore;\n    static accessor libDir: string = '/bry-libs/';\n    static syncMaxOnceEvery: number = 1000;\n    static router: RouterType = 'browser';\n\n\n    documents = observable.array<Document>([]);\n    \n    constructor(root: RootStore) {\n        this.root = root;\n    }\n\n    @action\n    addDocument(document: Document) {\n        this.documents.push(document);\n    }\n\n    find = computedFn(\n        function (this: DocumentStore, id?: string): Document | undefined {\n            if (!id) {\n                return;\n            }\n            return this.documents.find((d) => d.id === id) as Document | undefined;\n        },\n        { keepAlive: true }\n    );\n\n}\n"})})]}),"\n",(0,r.jsxs)(t,{children:[(0,r.jsx)("summary",{children:(0,r.jsx)(n.code,{children:"src/models/Document.ts"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="src/models/Document.ts"',children:"import { action, computed, observable, reaction } from 'mobx';\nimport { DocumentStore } from '../stores/documentStore';\nimport { v4 as uuidv4 } from 'uuid';\nimport { sanitizePyScript, splitPreCode } from 'docusaurus-live-brython/theme/CodeEditor/WithScript/helpers';\nimport throttle from 'lodash/throttle';\nimport { \n    CANVAS_OUTPUT_TESTER, \n    DOM_ELEMENT_IDS, \n    GRAPHICS_OUTPUT_TESTER, \n    GRID_IMPORTS_TESTER, \n    TURTLE_IMPORTS_TESTER \n} from 'docusaurus-live-brython/theme/CodeEditor/constants';\nimport { \n    type InitState, \n    type LogMessage, \n    type Version,\n    Status\n} from 'docusaurus-live-brython/theme/CodeEditor/WithScript/Types';\nimport { runCode } from 'docusaurus-live-brython/theme/CodeEditor/WithScript/bryRunner';\n\n\nexport default class Document {\n    readonly store: DocumentStore;\n    readonly isVersioned: boolean;\n    readonly _pristineCode: string;\n    readonly id: string;\n    readonly codeId: string;\n    readonly source: 'local' | 'remote';\n    readonly _lang: 'py' | string;\n    readonly preCode: string;\n    readonly postCode: string;\n    @observable accessor createdAt: Date;\n    @observable accessor updatedAt: Date;\n    @observable accessor code: string;\n    @observable accessor isExecuting: boolean;\n    @observable accessor showRaw: boolean;\n    @observable accessor isLoaded: boolean;\n    @observable accessor status: Status = Status.IDLE;\n    @observable accessor graphicsModalExecutionNr: number; /* 0 = closed, >0 = open */\n    @observable accessor isPasted: boolean = false;\n    versions = observable.array<Version>([], {deep: false});\n    logs = observable.array<LogMessage>([], {deep: false});\n\n\n    constructor(props: InitState, store: DocumentStore) {\n        this.store = store;\n        this.id = props.id || uuidv4();\n        this.source = props.id ? 'remote' : 'local';\n        this._lang = props.lang;\n        this.isExecuting = false;\n        this.showRaw = false;\n        this.isLoaded = true;\n        this.isVersioned = props.versioned && this.source === 'remote';\n        this._pristineCode = props.code;\n        this.code = props.code;\n        if (this.isVersioned) {\n            this.versions.push({code: props.code, createdAt: new Date(), version: 1});\n        }\n        this.preCode = props.preCode;\n        this.postCode = props.postCode;\n        this.codeId = `code.${props.title || props.lang}.${this.id}`.replace(/(-|\\.)/g, '_');\n        this.updatedAt = new Date();\n        this.createdAt = new Date();\n    }\n\n    @action\n    clearLogMessages() {\n        this.logs.clear();\n    }\n\n    @action\n    setExecuting(isExecuting: boolean) {\n        this.isExecuting = isExecuting;\n    }\n\n    @action\n    addLogMessage(message: LogMessage) {\n        this.logs.push({output: message.output, timeStamp: Date.now(), type: message.type});\n    }\n\n    @action\n    setCode(code: string, action?: 'insert' | 'remove' | string) {\n        if (this.isPasted && action === 'remove') {\n            return;\n        }\n        this.code = code;\n        const updatedAt = new Date();\n        this.updatedAt = updatedAt;\n        if (this.isVersioned) {\n            this.addVersion({\n                code: code,\n                createdAt: updatedAt,\n                version: this.versions.length + 1,\n                pasted: this.isPasted\n            });\n        }\n        if (this.isPasted) {\n            this.isPasted = false;\n        }\n\n        /**\n         * call the api to save the code...\n         */\n    }\n\n    @action\n    loadVersions() {\n        // nop\n    }\n\n    \n    @action\n    _addVersion(version: Version) {\n        if (!this.isVersioned) {\n            return;\n        }\n        this.versions.push(version);\n    }\n\n    addVersion = throttle(\n        this._addVersion,\n        DocumentStore.syncMaxOnceEvery,\n        {leading: false, trailing: true}\n    );\n\n    @computed\n    get _codeToExecute() {\n        return `${this.preCode}\\n${this.code}\\n${this.postCode}`;\n    }\n\n    @action\n    execScript() {\n        if (this.hasGraphicsOutput) {\n            this.graphicsModalExecutionNr = this.graphicsModalExecutionNr + 1;\n        }\n        this.isExecuting = true;\n        runCode(this.code, this.preCode, this.postCode, this.codeId, DocumentStore.libDir, DocumentStore.router);\n    }\n\n    @action\n    saveNow() {\n        /**\n         * call the api to save the code...\n         */\n    }\n\n    /**\n     * stop the script from running\n     * wheter the script is running or not is derived from the\n     * `data--start-time` attribute on the communicator element.\n     * This is used in combination with the game loop\n     */\n    @action\n    stopScript() {\n        const code = document?.getElementById(DOM_ELEMENT_IDS.communicator(this.codeId));\n        if (code) {\n            code.removeAttribute('data--start-time');\n        }\n    }\n\n    @computed\n    get hasGraphicsOutput() {\n        return this.hasTurtleOutput || this.hasCanvasOutput || GRAPHICS_OUTPUT_TESTER.test(this._codeToExecute);\n    }\n\n    @computed\n    get hasTurtleOutput() {\n        return TURTLE_IMPORTS_TESTER.test(this._codeToExecute);\n    }\n\n\n    @computed\n    get hasCanvasOutput() {\n        return CANVAS_OUTPUT_TESTER.test(this._codeToExecute) || GRID_IMPORTS_TESTER.test(this._codeToExecute);\n    }\n\n    @computed\n    get hasEdits() {\n        return this.code !== this.pristineCode;\n    }\n\n    @computed\n    get versionsLoaded() {\n        return true;\n    }\n\n\n    @action\n    closeGraphicsModal() {\n        this.graphicsModalExecutionNr = 0;\n    }\n\n    subscribe(listener: () => void, selector: keyof Document) {\n        if (Array.isArray(this[selector])) {\n            return reaction(\n                () => (this[selector] as Array<any>).slice().length,\n                (curr, prev) => {\n                    listener();\n                }\n            );\n        }\n        return reaction(\n            () => this[selector],\n            listener\n        );\n    }\n\n    @computed\n    get pristineCode() {\n        return this._pristineCode;\n    }\n\n    @action\n    setIsPasted(isPasted: boolean) {\n        this.isPasted = isPasted;\n    };\n    @action\n    setShowRaw(showRaw: boolean) {\n        this.showRaw = showRaw;\n    };\n    @action\n    setStatus(status: Status) {\n        this.status = status;\n    };\n\n    get lang() {\n        if (this._lang === 'py') {\n            return 'python';\n        }\n        return this._lang;\n    }\n}\n"})})]}),"\n",(0,r.jsxs)(n.p,{children:["\u4F7F\u7528 ",(0,r.jsx)(n.code,{children:"useSyncExternalStore"})," \u9264\u5B50\uFF0C\u60A8\u53EF\u4EE5\u8A2D\u7F6E ",(0,r.jsx)(n.code,{children:"docusaurus-live-brython"})," \u548C\u7531 mobx \u8DDF\u8E64\u7684 ",(0,r.jsx)(n.code,{children:"Document"})," \u6A21\u578B\u4E4B\u9593\u7684\u540C\u6B65\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="src/theme/CodeEditor/hooks/useScript.ts"',children:'import Document from "@site/src/models/Document";\nimport { useCallback, useSyncExternalStore } from "react";\nexport const useScript = <T extends keyof Document>(model: Document, selector: T): Document[T] => {\n    const isArray = Array.isArray(model[selector]);\n    if (isArray) {\n        // Arrays (logs and versions) are treated differently, see the details below\n    }\n    return useSyncExternalStore(\n        useCallback((callback) => {\n            return model.subscribe(callback, selector);\n        }, [model, selector]),\n        useCallback(\n            () => {\n                return model[selector];\n            },\n            [model, selector]\n        )\n    );\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"model"})," \u63D0\u4F9B\u4E86\u4E00\u500B ",(0,r.jsx)(n.code,{children:"subscribe"})," \u51FD\u5F0F\uFF0C\u7528\u65BC\u8A2D\u7F6E\u5C0D\u6307\u5B9A ",(0,r.jsx)(n.code,{children:"selector"})," \u8B8A\u5316\u7684\u53CD\u61C9\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="src/models/Document.ts"',children:"    subscribe(listener: () => void, selector: keyof Document) {\n        if (Array.isArray(this[selector])) {\n            return reaction(\n                () => (this[selector] as Array<any>).slice().length,\n                listener\n            );\n        }\n        return reaction(\n            () => this[selector],\n            listener\n        );\n    }\n"})}),"\n",(0,r.jsxs)(t,{children:[(0,r.jsxs)("summary",{children:["\u5B8C\u6574 ",(0,r.jsx)(n.code,{children:"useScript.ts"})," \u4F86\u6E90"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="src/theme/CodeEditor/hooks/useScript.ts"',children:'import Document from "@site/src/models/Document";\nimport { useCallback, useSyncExternalStore } from "react";\n/**\n * A utility function to create a stable snapshot wrapper\n * it is meant to only track the length of the array and treats\n * two arrays with the same length as equal\n */\nconst useStableSnapshot = (getSnapshot: () => Array<any>) => {\n    let prevLength: number = -1;\n    let prevResult: Array<any>;\n    return () => {\n        const result = getSnapshot();\n        if (result.length !== prevLength) {\n            prevLength = result.length;\n            prevResult = result.slice();\n        }\n        return prevResult;\n    };\n};\n\nexport const useScript = <T extends keyof Document>(model: Document, selector: T): Document[T] => {\n    const isArray = Array.isArray(model[selector]);\n    if (isArray) {\n        /**\n         * arrays are treated differently as they are expected to be\n         * immutable, so we can use a stable snapshot to track changes\n         * in the array\n         */\n        return useSyncExternalStore(\n            useCallback((callback) => {\n                return model.subscribe(callback, selector);\n            }, [model, selector]),\n            useCallback(\n                useStableSnapshot(() => {\n                    return model[selector] as Array<any>;\n                }) as () => Document[T],\n                [model, selector]\n            )\n        );\n    }\n    return useSyncExternalStore(\n        useCallback((callback) => {\n            return model.subscribe(callback, selector);\n        }, [model, selector]),\n        useCallback(\n            () => {\n                return model[selector];\n            },\n            [model, selector]\n        )\n    );\n}\n'})})]}),"\n",(0,r.jsxs)(n.p,{children:["\u7531\u65BC ",(0,r.jsx)(n.code,{children:"docusaurus-live-brython"})," \u4E2D\u7684\u72C0\u614B\u901A\u904E ",(0,r.jsx)(n.code,{children:"ScriptContext"})," \u50B3\u905E\uFF0C\u60A8\u9700\u8981\u4EA4\u63DB ",(0,r.jsx)(n.code,{children:"ScriptContext"})," \u4EE5\u5C07 mobx \u7684 ",(0,r.jsx)(n.code,{children:"Document"})," \u63D0\u4F9B\u7D66 ",(0,r.jsx)(n.code,{children:"CodeEditor"})," \u53CA\u5176\u6240\u6709\u7D44\u4EF6\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u9019\u88E1\u60A8\u53EF\u4EE5\u770B\u5230\uFF0C\u7576 ",(0,r.jsx)(n.code,{children:"ScriptContext"})," \u88AB\u639B\u8F09\u6642\u5275\u5EFA\u4E86 ",(0,r.jsx)(n.code,{children:"Document"})," \u4E26\u5C07\u5176\u6DFB\u52A0\u5230 ",(0,r.jsx)(n.code,{children:"DocumentStore"}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="src/theme/CodeEditor/WithScript/ScriptContext.tsx"',children:'import React from "react";\nimport { usePluginData } from "@docusaurus/useGlobalData";\nimport { observer } from "mobx-react-lite";\nimport { InitState } from "docusaurus-live-brython/theme/CodeEditor/WithScript/Types";\nimport Document from "@site/src/models/Document";\nimport { useStore } from "@site/src/hooks/useStore";\nimport BrowserOnly from \'@docusaurus/BrowserOnly\';\nimport CodeBlock from \'@theme/CodeBlock\';\nexport const Context = React.createContext<Document | undefined>(undefined);\nimport { v4 as uuidv4 } from \'uuid\';\n\nconst ScriptContext = observer((props: InitState & { children: React.ReactNode; }) => {\n    const [id, setId] = React.useState<string>(props.id || uuidv4());\n    const documentStore = useStore(\'documentStore\');\n    React.useEffect(() => {\n        const doc = documentStore.find(id);\n        if (doc) {\n            return;\n        }\n        const document = new Document({...props, id: id}, documentStore);\n        documentStore.addDocument(document);\n    }, [props.id, documentStore]);\n    \n    return (\n        <BrowserOnly fallback={<CodeBlock language={props.lang}>{props.code}</CodeBlock>}>\n            {() => {\n                if (!documentStore.find(id)) {\n                    return (<CodeBlock language={props.lang}>{props.code}</CodeBlock>);\n                }\n                return (\n                    <Context.Provider value={documentStore.find(id)}>\n                        {props.children}\n                    </Context.Provider>\n                );\n            }}\n        </BrowserOnly>\n    );\n});\n\nexport default ScriptContext;\n'})})]})}function u(e={}){let{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}}}]);